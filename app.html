<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detectus - B·∫£ng ƒêi·ªÅu Khi·ªÉn ·ª®ng D·ª•ng</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #0D1117;
            color: #E6EDF3;
            background-image:
                linear-gradient(rgba(13, 17, 23, 0.98), rgba(13, 17, 23, 0.98));
            overflow-x: hidden;
        }
        #background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background-color: #58A6FF;
            border-radius: 50%;
            opacity: 0;
            animation: animate-star 10s linear infinite;
        }
        @keyframes animate-star {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            20%, 80% { opacity: 0.7; }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }
        .glass-card {
            background-color: rgba(22, 27, 34, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 148, 158, 0.2);
        }
        .text-glow { color: #58A6FF; text-shadow: 0 0 8px #58A6FF60; }
        .loader {
            border: 4px solid #30363d;
            border-top: 4px solid #58A6FF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: rgba(13, 17, 23, 0.8);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 148, 158, 0.3);
            padding: 2rem; border-radius: 0.75rem; max-width: 500px;
            width: 90%; text-align: center; transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .web3-btn {
            background: linear-gradient(90deg, #0052CC, #4C9AFF); border: none;
            box-shadow: 0 0 15px #4C9AFF80; transition: all 0.3s ease;
        }
        .web3-btn:hover { box-shadow: 0 0 25px #4C9AFFAA; transform: translateY(-2px); }
        .web3-btn:disabled { background: #30363d; cursor: not-allowed; box-shadow: none; transform: none; }
        .web3-input {
            background-color: #0D1117; border: 1px solid #30363d; color: #E6EDF3;
        }
        .web3-input:focus {
            border-color: #58A6FF; box-shadow: 0 0 0 3px #58A6FF30;
        }
        .progress-bar-bg { background-color: #30363d; }
        .progress-bar-fg { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">
    <div id="background-animation"></div>

    <div id="main-loader" class="flex items-center justify-center min-h-screen">
        <div class="loader"></div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 relative z-10 hidden">

        <header class="text-center pt-8 pb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-glow leading-tight tracking-wider">B·∫¢NG ƒêI·ªÄU KHI·ªÇN DAPP</h1>
            <p id="loggedInUserDisplay" class="font-mono text-sm text-green-400 mt-4"></p>
        </header>

        <main class="space-y-16">
            
            <section id="live-dashboard">
                <div class="glass-card rounded-xl shadow-lg p-6 md:p-8">
                    <h2 class="text-3xl font-bold text-center mb-6 text-glow">Gi√°m S√°t & Giao D·ªãch</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-1 space-y-4">
                            <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                                <h4 class="font-bold text-gray-400 mb-2">Tr·∫°ng Th√°i V√≠</h4>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">C·∫•p ƒê·ªô R·ªßi Ro:</span>
                                    <span id="walletRiskStatus" class="font-bold px-2 py-1 rounded-full text-sm"></span>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-gray-300">Tr·∫°ng Th√°i ƒê√≥ng BƒÉng:</span>
                                    <span id="walletFrozenStatus" class="font-bold"></span>
                                </div>
                            </div>
                             <div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                                <h4 class="font-bold text-gray-400 mb-2">B·ªô ƒê·∫øm H√†nh Vi Nghi Ng·ªù</h4>
                                <div class="w-full progress-bar-bg rounded-full h-2.5">
                                    <div id="suspiciousCountBar" class="bg-yellow-400 h-2.5 rounded-full progress-bar-fg"></div>
                                </div>
                                <p id="suspiciousCountText" class="text-right text-sm mt-1 text-gray-400"></p>
                            </div>
                        </div>

                        <div class="lg:col-span-2 p-4 rounded-lg bg-slate-800/50 border border-slate-700">
                            <h3 class="text-xl font-bold text-center mb-4 text-glow">M√¥ Ph·ªèng Giao D·ªãch</h3>
                             <div class="space-y-4">
                                <div>
                                    <label for="recipientWallet" class="font-semibold text-gray-300">V√≠ Nh·∫≠n:</label>
                                    <input type="text" id="recipientWallet" class="web3-input w-full mt-1 p-3 rounded-lg outline-none" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√≠ nh·∫≠n">
                                </div>
                                <div>
                                    <label for="amount" class="font-semibold text-gray-300">S·ªë Ti·ªÅn (ETH):</label>
                                    <input type="number" id="amount" class="web3-input w-full mt-1 p-3 rounded-lg outline-none" placeholder="Ng∆∞·ª°ng nghi ng·ªù: 10 ETH">
                                </div>
                                <button id="sendTxBtn" class="w-full web3-btn text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center">
                                    G·ª≠i Giao D·ªãch
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="transaction-history">
                <div class="glass-card rounded-xl shadow-lg p-6 md:p-8">
                    <h2 class="text-3xl font-bold text-center mb-2 text-glow">L·ªãch S·ª≠ Giao D·ªãch C·ªßa B·∫°n üìì</h2>
                    <div id="historyContainer" class="mt-6 max-h-96 overflow-y-auto space-y-4 pr-2">
                        <div id="history-loader" class="loader"></div>
                        <p id="no-history-msg" class="text-center text-gray-500 hidden">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë∆∞·ª£c th·ª±c hi·ªán.</p>
                    </div>
                </div>
            </section>
            
            <section id="ai-analysis">
                <div class="glass-card rounded-xl shadow-lg p-6 md:p-8">
                    <h2 class="text-3xl font-bold text-center mb-2 text-glow">Ph√¢n T√≠ch V√≠ B·∫±ng AI (Off-chain) ‚ú®</h2>
                    <p class="text-center max-w-2xl mx-auto text-gray-400 mb-8">
                        S·ª≠ d·ª•ng Gemini ƒë·ªÉ c√≥ m·ªôt g√≥c nh√¨n kh√°c v·ªÅ r·ªßi ro c·ªßa m·ªôt ƒë·ªãa ch·ªâ v√≠, d·ª±a tr√™n ph√¢n t√≠ch h√†nh vi m√¥ ph·ªèng.
                    </p>
                    <div class="max-w-xl mx-auto">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="walletAddressInput" class="web3-input flex-grow p-3 rounded-lg outline-none" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√≠, v√≠ d·ª•: risky-wallet">
                            <button id="analyzeWalletBtn" class="web3-btn text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center">
                                Ph√¢n T√≠ch v·ªõi AI ‚ú®
                            </button>
                        </div>
                        <div id="aiLoader" class="loader hidden"></div>
                        <div id="aiResultContainer" class="mt-6 p-4 border-2 rounded-lg bg-slate-900/50 hidden">
                            <h4 id="aiResultTitle" class="font-bold text-lg mb-2"></h4>
                            <p id="aiResultContent" class="text-gray-300 whitespace-pre-wrap"></p>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <footer class="text-center py-12 mt-8 border-t border-slate-800">
             <button id="logoutBtn" class="web3-btn text-white font-bold py-2 px-6 rounded-lg">ƒêƒÉng Xu·∫•t</button>
        </footer>
    </div>
    
    <div id="tx-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="tx-modal-loader" class="loader"></div>
            <div id="tx-modal-result" class="hidden">
                 <div id="tx-modal-icon" class="mb-4"></div>
                 <h3 id="tx-modal-title" class="text-2xl font-bold mb-2"></h3>
                 <p id="tx-modal-message" class="text-gray-400 mb-6"></p>
                 <button id="close-tx-modal-btn" class="web3-btn text-white font-bold py-2 px-6 rounded-lg">ƒê√≥ng</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', async () => {
    const API_BASE_URL = 'https://detectus.onrender.com';
    const loggedInUser = localStorage.getItem('loggedInUser');
    let currentUserData = null;

    const mainLoader = document.getElementById('main-loader');
    const appContainer = document.getElementById('app-container');
    const logoutBtn = document.getElementById('logoutBtn');
    const walletRiskStatus = document.getElementById('walletRiskStatus');
    const walletFrozenStatus = document.getElementById('walletFrozenStatus');
    const suspiciousCountBar = document.getElementById('suspiciousCountBar');
    const suspiciousCountText = document.getElementById('suspiciousCountText');
    const historyContainer = document.getElementById('historyContainer');
    const noHistoryMsg = document.getElementById('no-history-msg');
    const historyLoader = document.getElementById('history-loader');
    const sendTxBtn = document.getElementById('sendTxBtn');
    const txModal = document.getElementById('tx-modal');
    const txModalLoader = document.getElementById('tx-modal-loader');
    const txModalResult = document.getElementById('tx-modal-result');
    const txModalIcon = document.getElementById('tx-modal-icon');
    const txModalTitle = document.getElementById('tx-modal-title');
    const txModalMessage = document.getElementById('tx-modal-message');
    const closeTxModalBtn = document.getElementById('close-tx-modal-btn');

    if (!loggedInUser) {
        window.location.href = 'index.html';
        return;
    }

    async function initializeApp() {
        try {
            const response = await fetch(`${API_BASE_URL}/user/${loggedInUser}`);
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng.');
            }
            currentUserData = await response.json();
            updateDashboard();
        } catch (error) {
            console.error("Fetch User Error:", error);
            alert(error.message);
            logout();
        } finally {
            mainLoader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }
    }

    function updateDashboard() {
        if (!currentUserData) return;

        document.getElementById('loggedInUserDisplay').textContent = `ƒê√£ ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n: ${currentUserData.username}`;
        walletRiskStatus.textContent = currentUserData.risk;
        walletFrozenStatus.textContent = currentUserData.frozen ? 'B·ªã ƒê√≥ng BƒÉng' : 'Ho·∫°t ƒê·ªông';

        switch(currentUserData.risk) {
            case 'Safe': walletRiskStatus.className = 'font-bold px-2 py-1 rounded-full text-sm bg-teal-900/80 text-teal-300'; break;
            case 'Suspicious': walletRiskStatus.className = 'font-bold px-2 py-1 rounded-full text-sm bg-yellow-900/80 text-yellow-300'; break;
            case 'Blacklisted': walletRiskStatus.className = 'font-bold px-2 py-1 rounded-full text-sm bg-red-900/80 text-red-400'; break;
        }
        walletFrozenStatus.className = currentUserData.frozen ? 'font-bold text-red-400' : 'font-bold text-teal-300';

        const suspiciousLimit = 3;
        const suspiciousPercentage = (currentUserData.suspiciousCount / suspiciousLimit) * 100;
        suspiciousCountBar.style.width = `${Math.min(suspiciousPercentage, 100)}%`;
        suspiciousCountText.textContent = `${currentUserData.suspiciousCount} / ${suspiciousLimit} l·∫ßn vi ph·∫°m`;
        
        renderTransactionHistory();
    }

    function renderTransactionHistory() {
        historyLoader.classList.add('hidden');
        const history = currentUserData.history || [];
        
        const itemsToRemove = Array.from(historyContainer.children).filter(
            el => el.id !== 'no-history-msg' && el.id !== 'history-loader'
        );
        itemsToRemove.forEach(item => item.remove());

        if (history.length === 0) {
            noHistoryMsg.classList.remove('hidden');
        } else {
            noHistoryMsg.classList.add('hidden');
            history.slice().reverse().forEach(tx => {
                let statusClass, statusIcon;
                switch(tx.status) {
                    case 'Th√†nh C√¥ng': statusClass = 'text-teal-300 bg-teal-900/50'; statusIcon = '‚úÖ'; break;
                    case 'B·ªã C·∫£nh B√°o': statusClass = 'text-yellow-300 bg-yellow-900/50'; statusIcon = '‚ö†Ô∏è'; break;
                    case 'B·ªã Ch·∫∑n': statusClass = 'text-red-400 bg-red-900/50'; statusIcon = 'üö´'; break;
                    default: statusClass = 'text-gray-400 bg-gray-700'; statusIcon = '‚ùî'; break;
                }
                const txElement = document.createElement('div');
                txElement.className = 'p-4 rounded-lg border border-slate-700 bg-slate-800/50 flex items-start gap-4';
                txElement.innerHTML = `
                    <div class="text-2xl pt-1">${statusIcon}</div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg text-white">${tx.amount} ETH</p>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${tx.status}</span>
                        </div>
                        <p class="text-sm text-gray-400 break-all"><b class="text-gray-500">T·ª´:</b> ${tx.sender}</p>
                        <p class="text-sm text-gray-400 break-all"><b class="text-gray-500">ƒê·∫øn:</b> ${tx.recipient}</p>
                        <p class="text-xs text-gray-500 mt-2">${new Date(tx.timestamp).toLocaleString('vi-VN')}</p>
                    </div>`;
                historyContainer.appendChild(txElement);
            });
        }
    }

    async function handleSendTransaction() {
        const recipientId = document.getElementById('recipientWallet').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        
        if (!recipientId || isNaN(amount) || amount <= 0) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† h·ª£p l·ªá th√¥ng tin V√≠ Nh·∫≠n v√† S·ªë Ti·ªÅn.");
            return;
        }

        txModal.classList.remove('hidden');
        txModalLoader.classList.remove('hidden');
        txModalResult.classList.add('hidden');

        const newTransaction = {
            sender: currentUserData.username,
            recipient: recipientId,
            amount,
        };

        try {
            const response = await fetch(`${API_BASE_URL}/update-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUserData.username,
                    newTransaction: newTransaction
                })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'L·ªói khi c·∫≠p nh·∫≠t giao d·ªãch.');
            }
            
            currentUserData = data.user;
            updateDashboard();

            const lastTx = currentUserData.history[currentUserData.history.length - 1];
            let modalIcon, modalTitle, modalMessage, modalTitleClass;
            const successIcon = `<svg class="w-16 h-16 mx-auto text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            const warningIcon = `<svg class="w-16 h-16 mx-auto text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            const blockedIcon = `<svg class="w-16 h-16 mx-auto text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;

            switch(lastTx.status) {
                case 'Th√†nh C√¥ng':
                    modalIcon = successIcon;
                    modalTitle = 'Giao D·ªãch Th√†nh C√¥ng';
                    modalTitleClass = 'text-2xl font-bold mb-2 text-teal-400';
                    modalMessage = `Giao d·ªãch ${lastTx.amount} ETH ƒë·∫øn v√≠ ${lastTx.recipient} ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.`;
                    break;
                case 'B·ªã C·∫£nh B√°o':
                     modalIcon = warningIcon;
                    modalTitle = 'Giao D·ªãch B·ªã C·∫£nh B√°o';
                    modalTitleClass = 'text-2xl font-bold mb-2 text-yellow-400';
                    modalMessage = `Giao d·ªãch ${lastTx.amount} ETH ƒë√£ th√†nh c√¥ng, nh∆∞ng b·ªã g·∫Øn c·ªù 'ƒê√°ng Ng·ªù' do v∆∞·ª£t ng∆∞·ª°ng gi√° tr·ªã. B·ªô ƒë·∫øm vi ph·∫°m c·ªßa b·∫°n ƒë√£ tƒÉng l√™n.`;
                    break;
                case 'B·ªã Ch·∫∑n':
                    modalIcon = blockedIcon;
                    modalTitle = 'Giao D·ªãch B·ªã Ch·∫∑n';
                    modalTitleClass = 'text-2xl font-bold mb-2 text-red-400';
                    modalMessage = `Giao d·ªãch ƒë√£ b·ªã ch·∫∑n. V√≠ g·ª≠i ƒëang ·ªü tr·∫°ng th√°i ${currentUserData.risk === 'Blacklisted' ? 'Blacklisted' : 'B·ªã ƒê√≥ng BƒÉng'}.`;
                    break;
            }
             txModalIcon.innerHTML = modalIcon;
             txModalTitle.textContent = modalTitle;
             txModalTitle.className = modalTitleClass;
             txModalMessage.textContent = modalMessage;

        } catch (error) {
            console.error("Update User Error:", error);
            txModalIcon.innerHTML = blockedIcon;
            txModalTitle.textContent = 'L·ªói C·∫≠p Nh·∫≠t';
            txModalTitle.className = 'text-2xl font-bold mb-2 text-red-400';
            txModalMessage.textContent = `Kh√¥ng th·ªÉ l∆∞u giao d·ªãch v√†o c∆° s·ªü d·ªØ li·ªáu. L·ªói: ${error.message}`;
        } finally {
            setTimeout(() => {
                txModalLoader.classList.add('hidden');
                txModalResult.classList.remove('hidden');
            }, 1000);
        }
    }

    function logout() {
        localStorage.removeItem('loggedInUser');
        window.location.href = 'index.html';
    }


    logoutBtn.addEventListener('click', logout);
    sendTxBtn.addEventListener('click', handleSendTransaction);
    closeTxModalBtn.addEventListener('click', () => txModal.classList.add('hidden'));

    const analyzeWalletBtn = document.getElementById('analyzeWalletBtn');
    const walletAddressInput = document.getElementById('walletAddressInput');
    const aiLoader = document.getElementById('aiLoader');
    const aiResultContainer = document.getElementById('aiResultContainer');
    const aiResultTitle = document.getElementById('aiResultTitle');
    const aiResultContent = document.getElementById('aiResultContent');
    const walletProfiles = {
        'safe-wallet': { history: "L·ªãch s·ª≠ giao d·ªãch: N·∫Øm gi·ªØ d√†i h·∫°n, swap th∆∞·ªùng xuy√™n tr√™n c√°c DEX n·ªïi ti·∫øng nh∆∞ Uniswap, th·ªânh tho·∫£ng mua NFT t·ª´ OpenSea. Kh√¥ng c√≥ t∆∞∆°ng t√°c v·ªõi c√°c d·ªãch v·ª• tr·ªôn ti·ªÅn (mixer) ho·∫∑c c√°c ƒë·ªãa ch·ªâ b·ªã g·∫Øn c·ªù.", risk: "An To√†n", borderColor: "border-teal-400" },
        'suspicious-wallet': { history: "L·ªãch s·ª≠ giao d·ªãch: Nh·∫≠n m·ªôt kho·∫£n ti·ªÅn l·ªõn t·ª´ m·ªôt ngu·ªìn kh√¥ng x√°c ƒë·ªãnh, sau ƒë√≥ ngay l·∫≠p t·ª©c ph√¢n ph·ªëi ƒë·∫øn nhi·ªÅu v√≠ m·ªõi theo m·ªôt m√¥ h√¨nh gi·ªëng nh∆∞ 'smurfing' (chia nh·ªè). ƒê√£ t∆∞∆°ng t√°c v·ªõi m·ªôt h·ª£p ƒë·ªìng th√¥ng minh m·ªõi ƒë∆∞·ª£c tri·ªÉn khai, ch∆∞a ƒë∆∞·ª£c x√°c minh.", risk: "ƒê√°ng Ng·ªù", borderColor: "border-yellow-400" },
        'risky-wallet': { history: "L·ªãch s·ª≠ giao d·ªãch: T∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi Tornado Cash (m·ªôt d·ªãch v·ª• tr·ªôn ti·ªÅn ƒë√£ bi·∫øt). Nh·∫≠n ti·ªÅn t·ª´ m·ªôt ƒë·ªãa ch·ªâ li√™n quan ƒë·∫øn v·ª• hack c·ªßa Lazarus Group. G·ª≠i ti·ªÅn ƒë·∫øn m·ªôt s√†n giao d·ªãch c√≥ ch√≠nh s√°ch KYC/AML y·∫øu.", risk: "R·ªßi Ro Cao", borderColor: "border-red-400" }
    };
    analyzeWalletBtn.addEventListener('click', async () => {
        const walletAddress = walletAddressInput.value.trim().toLowerCase();
        if (!walletAddress) {
            aiResultTitle.textContent = "L·ªói";
            aiResultContent.textContent = "Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ v√≠.";
            aiResultContainer.classList.remove('hidden');
            aiResultContainer.className = 'mt-6 p-4 border-2 rounded-lg bg-slate-900/50 border-slate-700';
            return;
        }
        let profile = walletProfiles[walletAddress] || walletProfiles[Object.keys(walletProfiles)[Math.floor(Math.random() * Object.keys(walletProfiles).length)]];
        aiLoader.classList.remove('hidden');
        aiResultContainer.classList.add('hidden');
        const prompt = `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch an ninh blockchain. Ph√¢n t√≠ch l·ªãch s·ª≠ giao d·ªãch m√¥ ph·ªèng sau ƒë√¢y cho ƒë·ªãa ch·ªâ v√≠ "${walletAddress}" v√† ƒë∆∞a ra m·ªôt b·∫£n ƒë√°nh gi√° r·ªßi ro chi ti·∫øt nh∆∞ng d·ªÖ hi·ªÉu cho ng∆∞·ªùi d√πng cu·ªëi. Gi·∫£i th√≠ch l√Ω do c·ªßa b·∫°n d·ª±a tr√™n c√°c m·∫´u h√†nh vi.\n\nL·ªãch s·ª≠ giao d·ªãch m√¥ ph·ªèng:\n${profile.history}\n\nD·ª±a tr√™n nh·ªØng m·∫´u n√†y, h√£y cung c·∫•p:\n1. M·ªôt k·∫øt lu·∫≠n r√µ r√†ng v·ªÅ m·ª©c ƒë·ªô r·ªßi ro (An To√†n, ƒê√°ng Ng·ªù, ho·∫∑c R·ªßi Ro Cao).\n2. M·ªôt ƒëo·∫°n gi·∫£i th√≠ch ng·∫Øn g·ªçn (2-3 c√¢u) v·ªÅ c√°c d·∫•u hi·ªáu ch√≠nh b·∫°n ƒë√£ x√°c ƒë·ªãnh.\n3. C√°c ƒë·ªÅ xu·∫•t h√†nh ƒë·ªông cho ng∆∞·ªùi d√πng n·∫øu h·ªç ƒë·ªãnh t∆∞∆°ng t√°c v·ªõi v√≠ n√†y.\n\nH√£y tr√¨nh b√†y c√¢u tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;
        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { throw new Error(`API error: ${response.statusText}`); }
            const result = await response.json();
            let text = 'Kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i.';
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                text = result.candidates[0].content.parts[0].text;
            }
            aiResultTitle.textContent = `K·∫øt Qu·∫£ Ph√¢n T√≠ch cho V√≠: ${profile.risk}`;
            aiResultContent.textContent = text;
            aiResultContainer.className = `mt-6 p-4 border-2 rounded-lg bg-slate-900/50 ${profile.borderColor}`;
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            aiResultTitle.textContent = "L·ªói Ph√¢n T√≠ch";
            aiResultContent.textContent = "ƒê√£ x·∫£y ra s·ª± c·ªë khi k·∫øt n·ªëi v·ªõi d·ªãch v·ª• AI. Vui l√≤ng th·ª≠ l·∫°i sau.";
            aiResultContainer.className = 'mt-6 p-4 border-2 rounded-lg bg-slate-900/50 border-red-500';
        } finally {
            aiLoader.classList.add('hidden');
            aiResultContainer.classList.remove('hidden');
        }
    });


    await initializeApp();

    const background = document.getElementById('background-animation');
    const starCount = 150;
    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random() * 2 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.left = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 10}s`;
        star.style.animationDuration = `${Math.random() * 5 + 5}s`;
        background.appendChild(star);
    }
});
</script>
</body>
</html>
